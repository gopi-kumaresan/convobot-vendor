import { Injectable, Inject, PLATFORM_ID, Optional } from '@angular/core';
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { BehaviorSubject, from, EMPTY, zip, throwError } from 'rxjs';
import { catchError, tap, map, switchMap, filter, take } from 'rxjs/operators';
import { HIGHLIGHT_OPTIONS } from './highlight.model';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "./highlight.model";
// @dynamic
import * as ɵngcc0 from '@angular/core';
export class HighlightLoader {
    constructor(doc, platformId, _options) {
        this._options = _options;
        // Stream that emits when hljs library is loaded and ready to use
        this._ready = new BehaviorSubject(null);
        this.ready = this._ready.asObservable().pipe(filter((hljs) => !!hljs), map((hljs) => hljs), take(1));
        // Check if hljs is already available
        if (isPlatformBrowser(platformId) && doc.defaultView.hljs) {
            this._ready.next(doc.defaultView.hljs);
        }
        else {
            // Load hljs library
            this._loadLibrary().pipe(switchMap((hljs) => {
                if (this._options && this._options.lineNumbersLoader) {
                    // Make hljs available on window object (required for the line numbers library)
                    doc.defaultView.hljs = hljs;
                    // Load line numbers library
                    return this.loadLineNumbers().pipe(tap(() => this._ready.next(hljs)));
                }
                else {
                    this._ready.next(hljs);
                    return EMPTY;
                }
            }), catchError((e) => {
                console.error('[HLJS] ', e);
                return EMPTY;
            })).subscribe();
        }
    }
    /**
     * Lazy-Load highlight.js library
     */
    _loadLibrary() {
        if (this._options) {
            if (this._options.fullLibraryLoader && this._options.coreLibraryLoader) {
                return throwError('The full library and the core library were imported, only one of them should be imported!');
            }
            if (this._options.fullLibraryLoader && this._options.languages) {
                return throwError('The highlighting languages were imported they are not needed!');
            }
            if (this._options.coreLibraryLoader && !this._options.languages) {
                return throwError('The highlighting languages were not imported!');
            }
            if (!this._options.coreLibraryLoader && this._options.languages) {
                return throwError('The core library was not imported!');
            }
            if (this._options.fullLibraryLoader) {
                return this.loadFullLibrary();
            }
            if (this._options.coreLibraryLoader && this._options.languages && Object.keys(this._options.languages).length) {
                return this.loadCoreLibrary().pipe(switchMap((hljs) => this._loadLanguages(hljs)));
            }
        }
        return throwError('Highlight.js library was not imported!');
    }
    /**
     * Lazy-load highlight.js languages
     */
    _loadLanguages(hljs) {
        const languages = Object.entries(this._options.languages).map(([langName, langLoader]) => importModule(langLoader()).pipe(tap((langFunc) => hljs.registerLanguage(langName, langFunc))));
        return zip(...languages).pipe(map(() => hljs));
    }
    /**
     * Import highlight.js core library
     */
    loadCoreLibrary() {
        return importModule(this._options.coreLibraryLoader());
    }
    /**
     * Import highlight.js library with all languages
     */
    loadFullLibrary() {
        return importModule(this._options.fullLibraryLoader());
    }
    /**
     * Import line numbers library
     */
    loadLineNumbers() {
        return importModule(this._options.lineNumbersLoader());
    }
}
HighlightLoader.ɵfac = function HighlightLoader_Factory(t) { return new (t || HighlightLoader)(ɵngcc0.ɵɵinject(DOCUMENT), ɵngcc0.ɵɵinject(PLATFORM_ID), ɵngcc0.ɵɵinject(HIGHLIGHT_OPTIONS, 8)); };
HighlightLoader.ɵprov = i0.ɵɵdefineInjectable({ factory: function HighlightLoader_Factory() { return new HighlightLoader(i0.ɵɵinject(i1.DOCUMENT), i0.ɵɵinject(i0.PLATFORM_ID), i0.ɵɵinject(i2.HIGHLIGHT_OPTIONS, 8)); }, token: HighlightLoader, providedIn: "root" });
HighlightLoader.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [HIGHLIGHT_OPTIONS,] }] }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(HighlightLoader, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }, { type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [HIGHLIGHT_OPTIONS]
            }] }]; }, null); })();
/**
 * Map loader response to module object
 */
const importModule = (moduleLoader) => {
    return from(moduleLoader).pipe(filter((module) => !!module && !!module.default), map((module) => module.default));
};
const ɵ0 = importModule;
export { ɵ0 };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmxvYWRlci5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWhpZ2hsaWdodGpzL3NyYy9saWIvaGlnaGxpZ2h0LmxvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsZUFBZSxFQUFjLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRixPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMvRSxPQUFPLEVBQUUsaUJBQWlCLEVBQXNDLE1BQU0sbUJBQW1CLENBQUM7QUFFMUY7QUFFWTtBQUVnQjtBQUo1QixXQUFXOztBQUlYLE1BQU0sT0FBTyxlQUFlO0FBQzNCLElBUUMsWUFBOEIsR0FBUSxFQUNMLFVBQWtCLEVBQ1EsUUFBMEI7QUFDdEYsUUFENEQsYUFBUSxHQUFSLFFBQVEsQ0FBa0I7QUFBRSxRQVZ2RixpRUFBaUU7QUFDbEUsUUFBa0IsV0FBTSxHQUFHLElBQUksZUFBZSxDQUEwQixJQUFJLENBQUMsQ0FBQztBQUM5RSxRQUFVLFVBQUssR0FBaUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQzVFLE1BQU0sQ0FBQyxDQUFDLElBQTZCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFDakQsR0FBRyxDQUFDLENBQUMsSUFBNkIsRUFBRSxFQUFFLENBQUMsSUFBd0IsQ0FBQyxFQUNoRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQ1IsQ0FBQztB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QUFBLEFBRUEsQUFBQSxBQUlBLEFBQUEsQUFBQSxBQUFBLEFBU0EsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBVkEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBS0EsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFBQSxBQUVBLEFBRUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUVBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBR0EsQUFFQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFFQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBR0EsQUFFQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBcEdBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFVQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBeUZBLEFBRUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QsIFBMQVRGT1JNX0lELCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRE9DVU1FTlQsIGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgZnJvbSwgRU1QVFksIHppcCwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgdGFwLCBtYXAsIHN3aXRjaE1hcCwgZmlsdGVyLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSElHSExJR0hUX09QVElPTlMsIEhpZ2hsaWdodExpYnJhcnksIEhpZ2hsaWdodE9wdGlvbnMgfSBmcm9tICcuL2hpZ2hsaWdodC5tb2RlbCc7XG5cbi8vIEBkeW5hbWljXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBIaWdobGlnaHRMb2FkZXIge1xuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIGhsanMgbGlicmFyeSBpcyBsb2FkZWQgYW5kIHJlYWR5IHRvIHVzZVxuICBwcml2YXRlIHJlYWRvbmx5IF9yZWFkeSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8SGlnaGxpZ2h0TGlicmFyeSB8IG51bGw+KG51bGwpO1xuICByZWFkb25seSByZWFkeTogT2JzZXJ2YWJsZTxIaWdobGlnaHRMaWJyYXJ5PiA9IHRoaXMuX3JlYWR5LmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgZmlsdGVyKChobGpzOiBIaWdobGlnaHRMaWJyYXJ5IHwgbnVsbCkgPT4gISFobGpzKSxcbiAgICBtYXAoKGhsanM6IEhpZ2hsaWdodExpYnJhcnkgfCBudWxsKSA9PiBobGpzIGFzIEhpZ2hsaWdodExpYnJhcnkpLFxuICAgIHRha2UoMSlcbiAgKTtcblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KERPQ1VNRU5UKSBkb2M6IGFueSxcbiAgICAgICAgICAgICAgQEluamVjdChQTEFURk9STV9JRCkgcGxhdGZvcm1JZDogb2JqZWN0LFxuICAgICAgICAgICAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEhJR0hMSUdIVF9PUFRJT05TKSBwcml2YXRlIF9vcHRpb25zOiBIaWdobGlnaHRPcHRpb25zKSB7XG4gICAgLy8gQ2hlY2sgaWYgaGxqcyBpcyBhbHJlYWR5IGF2YWlsYWJsZVxuICAgIGlmIChpc1BsYXRmb3JtQnJvd3NlcihwbGF0Zm9ybUlkKSAmJiBkb2MuZGVmYXVsdFZpZXcuaGxqcykge1xuICAgICAgdGhpcy5fcmVhZHkubmV4dChkb2MuZGVmYXVsdFZpZXcuaGxqcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIExvYWQgaGxqcyBsaWJyYXJ5XG4gICAgICB0aGlzLl9sb2FkTGlicmFyeSgpLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoaGxqczogSGlnaGxpZ2h0TGlicmFyeSkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLl9vcHRpb25zICYmIHRoaXMuX29wdGlvbnMubGluZU51bWJlcnNMb2FkZXIpIHtcbiAgICAgICAgICAgIC8vIE1ha2UgaGxqcyBhdmFpbGFibGUgb24gd2luZG93IG9iamVjdCAocmVxdWlyZWQgZm9yIHRoZSBsaW5lIG51bWJlcnMgbGlicmFyeSlcbiAgICAgICAgICAgIGRvYy5kZWZhdWx0Vmlldy5obGpzID0gaGxqcztcbiAgICAgICAgICAgIC8vIExvYWQgbGluZSBudW1iZXJzIGxpYnJhcnlcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmxvYWRMaW5lTnVtYmVycygpLnBpcGUodGFwKCgpID0+IHRoaXMuX3JlYWR5Lm5leHQoaGxqcykpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fcmVhZHkubmV4dChobGpzKTtcbiAgICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICBjYXRjaEVycm9yKChlOiBhbnkpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdbSExKU10gJywgZSk7XG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgICB9KVxuICAgICAgKS5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGF6eS1Mb2FkIGhpZ2hsaWdodC5qcyBsaWJyYXJ5XG4gICAqL1xuICBwcml2YXRlIF9sb2FkTGlicmFyeSgpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICh0aGlzLl9vcHRpb25zKSB7XG4gICAgICBpZiAodGhpcy5fb3B0aW9ucy5mdWxsTGlicmFyeUxvYWRlciAmJiB0aGlzLl9vcHRpb25zLmNvcmVMaWJyYXJ5TG9hZGVyKSB7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdUaGUgZnVsbCBsaWJyYXJ5IGFuZCB0aGUgY29yZSBsaWJyYXJ5IHdlcmUgaW1wb3J0ZWQsIG9ubHkgb25lIG9mIHRoZW0gc2hvdWxkIGJlIGltcG9ydGVkIScpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX29wdGlvbnMuZnVsbExpYnJhcnlMb2FkZXIgJiYgdGhpcy5fb3B0aW9ucy5sYW5ndWFnZXMpIHtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ1RoZSBoaWdobGlnaHRpbmcgbGFuZ3VhZ2VzIHdlcmUgaW1wb3J0ZWQgdGhleSBhcmUgbm90IG5lZWRlZCEnKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLl9vcHRpb25zLmNvcmVMaWJyYXJ5TG9hZGVyICYmICF0aGlzLl9vcHRpb25zLmxhbmd1YWdlcykge1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignVGhlIGhpZ2hsaWdodGluZyBsYW5ndWFnZXMgd2VyZSBub3QgaW1wb3J0ZWQhJyk7XG4gICAgICB9XG4gICAgICBpZiAoIXRoaXMuX29wdGlvbnMuY29yZUxpYnJhcnlMb2FkZXIgJiYgdGhpcy5fb3B0aW9ucy5sYW5ndWFnZXMpIHtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ1RoZSBjb3JlIGxpYnJhcnkgd2FzIG5vdCBpbXBvcnRlZCEnKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLl9vcHRpb25zLmZ1bGxMaWJyYXJ5TG9hZGVyKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvYWRGdWxsTGlicmFyeSgpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX29wdGlvbnMuY29yZUxpYnJhcnlMb2FkZXIgJiYgdGhpcy5fb3B0aW9ucy5sYW5ndWFnZXMgJiYgT2JqZWN0LmtleXModGhpcy5fb3B0aW9ucy5sYW5ndWFnZXMpLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkQ29yZUxpYnJhcnkoKS5waXBlKHN3aXRjaE1hcCgoaGxqczogSGlnaGxpZ2h0TGlicmFyeSkgPT4gdGhpcy5fbG9hZExhbmd1YWdlcyhobGpzKSkpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhyb3dFcnJvcignSGlnaGxpZ2h0LmpzIGxpYnJhcnkgd2FzIG5vdCBpbXBvcnRlZCEnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMYXp5LWxvYWQgaGlnaGxpZ2h0LmpzIGxhbmd1YWdlc1xuICAgKi9cbiAgcHJpdmF0ZSBfbG9hZExhbmd1YWdlcyhobGpzOiBIaWdobGlnaHRMaWJyYXJ5KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBsYW5ndWFnZXMgPSBPYmplY3QuZW50cmllcyh0aGlzLl9vcHRpb25zLmxhbmd1YWdlcyEpLm1hcCgoW2xhbmdOYW1lLCBsYW5nTG9hZGVyXSkgPT5cbiAgICAgIGltcG9ydE1vZHVsZShsYW5nTG9hZGVyKCkpLnBpcGUoXG4gICAgICAgIHRhcCgobGFuZ0Z1bmM6IGFueSkgPT4gaGxqcy5yZWdpc3Rlckxhbmd1YWdlKGxhbmdOYW1lLCBsYW5nRnVuYykpXG4gICAgICApXG4gICAgKTtcbiAgICByZXR1cm4gemlwKC4uLmxhbmd1YWdlcykucGlwZShtYXAoKCkgPT4gaGxqcykpO1xuICB9XG5cblxuICAvKipcbiAgICogSW1wb3J0IGhpZ2hsaWdodC5qcyBjb3JlIGxpYnJhcnlcbiAgICovXG4gIHByaXZhdGUgbG9hZENvcmVMaWJyYXJ5KCk6IE9ic2VydmFibGU8SGlnaGxpZ2h0TGlicmFyeT4ge1xuICAgIHJldHVybiBpbXBvcnRNb2R1bGUodGhpcy5fb3B0aW9ucy5jb3JlTGlicmFyeUxvYWRlciEoKSk7XG4gIH1cblxuICAvKipcbiAgICogSW1wb3J0IGhpZ2hsaWdodC5qcyBsaWJyYXJ5IHdpdGggYWxsIGxhbmd1YWdlc1xuICAgKi9cbiAgcHJpdmF0ZSBsb2FkRnVsbExpYnJhcnkoKTogT2JzZXJ2YWJsZTxIaWdobGlnaHRMaWJyYXJ5PiB7XG4gICAgcmV0dXJuIGltcG9ydE1vZHVsZSh0aGlzLl9vcHRpb25zLmZ1bGxMaWJyYXJ5TG9hZGVyISgpKTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIEltcG9ydCBsaW5lIG51bWJlcnMgbGlicmFyeVxuICAgKi9cbiAgcHJpdmF0ZSBsb2FkTGluZU51bWJlcnMoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gaW1wb3J0TW9kdWxlKHRoaXMuX29wdGlvbnMubGluZU51bWJlcnNMb2FkZXIhKCkpO1xuICB9XG59XG5cbi8qKlxuICogTWFwIGxvYWRlciByZXNwb25zZSB0byBtb2R1bGUgb2JqZWN0XG4gKi9cbmNvbnN0IGltcG9ydE1vZHVsZSA9IChtb2R1bGVMb2FkZXI6IFByb21pc2U8YW55Pik6IE9ic2VydmFibGU8YW55PiA9PiB7XG4gIHJldHVybiBmcm9tKG1vZHVsZUxvYWRlcikucGlwZShcbiAgICBmaWx0ZXIoKG1vZHVsZTogYW55KSA9PiAhIW1vZHVsZSAmJiAhIW1vZHVsZS5kZWZhdWx0KSxcbiAgICBtYXAoKG1vZHVsZTogYW55KSA9PiBtb2R1bGUuZGVmYXVsdClcbiAgKTtcbn07XG4iXX0=