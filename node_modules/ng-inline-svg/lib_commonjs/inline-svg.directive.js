"use strict";
var ɵngcc0 = require('@angular/core');
var ɵngcc1 = require('./svg-cache.service');
var ɵngcc2 = require('./inline-svg.service');
var ɵngcc3 = require('./inline-svg.config');
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var common_1 = require("@angular/common");
var inline_svg_component_1 = require("./inline-svg.component");
var svg_cache_service_1 = require("./svg-cache.service");
var inline_svg_service_1 = require("./inline-svg.service");
var inline_svg_config_1 = require("./inline-svg.config");
var SvgUtil = require("./svg-util");
var InlineSVGDirective = (function () {
    function InlineSVGDirective(_el, _viewContainerRef, _resolver, _svgCache, _renderer, _inlineSVGService, _config, platformId) {
        this._el = _el;
        this._viewContainerRef = _viewContainerRef;
        this._resolver = _resolver;
        this._svgCache = _svgCache;
        this._renderer = _renderer;
        this._inlineSVGService = _inlineSVGService;
        this._config = _config;
        this.platformId = platformId;
        this.resolveSVGUrl = true;
        this.replaceContents = true;
        this.prepend = false;
        this.injectComponent = false;
        this.cacheSVG = true;
        this.forceEvalStyles = false;
        this.evalScripts = "always";
        this.onSVGInserted = new core_1.EventEmitter();
        this.onSVGFailed = new core_1.EventEmitter();
        this._supportsSVG = SvgUtil.isSvgSupported();
        if (!common_1.isPlatformServer(this.platformId) && !this._supportsSVG) {
            this._fail('Embed SVG are not supported by this browser');
        }
    }
    InlineSVGDirective.prototype.ngOnInit = function () {
        if (!this._isValidPlatform() || this._isSSRDisabled()) {
            return;
        }
        this._insertSVG();
    };
    InlineSVGDirective.prototype.ngOnChanges = function (changes) {
        if (!this._isValidPlatform() || this._isSSRDisabled()) {
            return;
        }
        if (changes['inlineSVG'] || changes['setSVGAttributes']) {
            this._insertSVG();
        }
    };
    InlineSVGDirective.prototype.ngOnDestroy = function () {
        if (this._subscription) {
            this._subscription.unsubscribe();
        }
    };
    InlineSVGDirective.prototype._insertSVG = function () {
        var _this = this;
        if (!common_1.isPlatformServer(this.platformId) && !this._supportsSVG) {
            return;
        }
        if (!this.inlineSVG) {
            this._fail('No URL passed to [inlineSVG]');
            return;
        }
        if (this.inlineSVG === this._prevUrl) {
            return;
        }
        this._prevUrl = this.inlineSVG;
        this._subscription = this._svgCache.getSVG(this.inlineSVG, this.resolveSVGUrl, this.cacheSVG)
            .subscribe(function (svg) {
            if (SvgUtil.isUrlSymbol(_this.inlineSVG)) {
                var symbolId = _this.inlineSVG.split('#')[1];
                svg = SvgUtil.createSymbolSvg(_this._renderer, svg, symbolId);
            }
            _this._processSvg(svg);
        }, function (err) {
            _this._fail(err);
        });
    };
    InlineSVGDirective.prototype._processSvg = function (svg) {
        if (!svg) {
            return;
        }
        if (this.removeSVGAttributes && common_1.isPlatformBrowser(this.platformId)) {
            SvgUtil.removeAttributes(svg, this.removeSVGAttributes);
        }
        if (this.setSVGAttributes) {
            SvgUtil.setAttributes(svg, this.setSVGAttributes);
        }
        if (this.onSVGLoaded) {
            svg = this.onSVGLoaded(svg, this._el.nativeElement);
        }
        this._insertEl(svg);
        if (common_1.isPlatformBrowser(this.platformId)) {
            this._inlineSVGService.evalScripts(svg, this.inlineSVG, this.evalScripts);
        }
        if (this.forceEvalStyles) {
            var styleTags = svg.querySelectorAll('style');
            Array.from(styleTags).forEach(function (tag) { return tag.textContent += ''; });
        }
        this.onSVGInserted.emit(svg);
    };
    InlineSVGDirective.prototype._insertEl = function (el) {
        if (this.injectComponent) {
            if (!this._svgComp) {
                var factory = this._resolver.resolveComponentFactory(inline_svg_component_1.InlineSVGComponent);
                this._svgComp = this._viewContainerRef.createComponent(factory);
            }
            this._svgComp.instance.context = this;
            this._svgComp.instance.replaceContents = this.replaceContents;
            this._svgComp.instance.prepend = this.prepend;
            this._svgComp.instance.content = el;
            this._renderer.appendChild(this._el.nativeElement, this._svgComp.injector.get(inline_svg_component_1.InlineSVGComponent)._el.nativeElement);
        }
        else {
            this._inlineSVGService.insertEl(this, this._el.nativeElement, el, this.replaceContents, this.prepend);
        }
    };
    InlineSVGDirective.prototype._fail = function (msg) {
        this.onSVGFailed.emit(msg);
        if (this.fallbackImgUrl) {
            var elImg = this._renderer.createElement('IMG');
            this._renderer.setAttribute(elImg, 'src', this.fallbackImgUrl);
            this._insertEl(elImg);
        }
    };
    InlineSVGDirective.prototype._isValidPlatform = function () {
        return common_1.isPlatformServer(this.platformId) || common_1.isPlatformBrowser(this.platformId);
    };
    InlineSVGDirective.prototype._isSSRDisabled = function () {
        return common_1.isPlatformServer(this.platformId) && this._config && this._config.clientOnly;
    };
    __decorate([
        core_1.Input(),
        __metadata("design:type", String)
    ], InlineSVGDirective.prototype, "inlineSVG", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "resolveSVGUrl", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "replaceContents", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "prepend", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "injectComponent", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "cacheSVG", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Object)
    ], InlineSVGDirective.prototype, "setSVGAttributes", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Array)
    ], InlineSVGDirective.prototype, "removeSVGAttributes", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Boolean)
    ], InlineSVGDirective.prototype, "forceEvalStyles", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", String)
    ], InlineSVGDirective.prototype, "evalScripts", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", String)
    ], InlineSVGDirective.prototype, "fallbackImgUrl", void 0);
    __decorate([
        core_1.Input(),
        __metadata("design:type", Function)
    ], InlineSVGDirective.prototype, "onSVGLoaded", void 0);
    __decorate([
        core_1.Output(),
        __metadata("design:type", core_1.EventEmitter)
    ], InlineSVGDirective.prototype, "onSVGInserted", void 0);
    __decorate([
        core_1.Output(),
        __metadata("design:type", core_1.EventEmitter)
    ], InlineSVGDirective.prototype, "onSVGFailed", void 0);
    InlineSVGDirective = __decorate([ __param(6, core_1.Optional()),
        __param(7, core_1.Inject(core_1.PLATFORM_ID)),
        __metadata("design:paramtypes", [core_1.ElementRef,
            core_1.ViewContainerRef,
            core_1.ComponentFactoryResolver,
            svg_cache_service_1.SVGCacheService,
            core_1.Renderer2,
            inline_svg_service_1.InlineSVGService,
            inline_svg_config_1.InlineSVGConfig,
            Object])
    ], InlineSVGDirective);
InlineSVGDirective.ɵfac = function InlineSVGDirective_Factory(t) { return new (t || InlineSVGDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ViewContainerRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ComponentFactoryResolver), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.SVGCacheService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Renderer2), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.InlineSVGService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.InlineSVGConfig, 8), ɵngcc0.ɵɵdirectiveInject(core_1.PLATFORM_ID)); };
InlineSVGDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: InlineSVGDirective, selectors: [["", "inlineSVG", ""]], inputs: { resolveSVGUrl: "resolveSVGUrl", replaceContents: "replaceContents", prepend: "prepend", injectComponent: "injectComponent", cacheSVG: "cacheSVG", forceEvalStyles: "forceEvalStyles", evalScripts: "evalScripts", inlineSVG: "inlineSVG", setSVGAttributes: "setSVGAttributes", removeSVGAttributes: "removeSVGAttributes", fallbackImgUrl: "fallbackImgUrl", onSVGLoaded: "onSVGLoaded" }, outputs: { onSVGInserted: "onSVGInserted", onSVGFailed: "onSVGFailed" }, features: [ɵngcc0.ɵɵProvidersFeature([svg_cache_service_1.SVGCacheService]), ɵngcc0.ɵɵNgOnChangesFeature] });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(InlineSVGDirective, [{
        type: core_1.Directive,
        args: [{
                selector: '[inlineSVG]',
                providers: [svg_cache_service_1.SVGCacheService]
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ɵngcc0.ViewContainerRef }, { type: ɵngcc0.ComponentFactoryResolver }, { type: ɵngcc1.SVGCacheService }, { type: ɵngcc0.Renderer2 }, { type: ɵngcc2.InlineSVGService }, { type: ɵngcc3.InlineSVGConfig, decorators: [{
                type: core_1.Optional
            }] }, { type: Object, decorators: [{
                type: core_1.Inject,
                args: [core_1.PLATFORM_ID]
            }] }]; }, { resolveSVGUrl: [{
            type: core_1.Input
        }], replaceContents: [{
            type: core_1.Input
        }], prepend: [{
            type: core_1.Input
        }], injectComponent: [{
            type: core_1.Input
        }], cacheSVG: [{
            type: core_1.Input
        }], forceEvalStyles: [{
            type: core_1.Input
        }], evalScripts: [{
            type: core_1.Input
        }], onSVGInserted: [{
            type: core_1.Output
        }], onSVGFailed: [{
            type: core_1.Output
        }], inlineSVG: [{
            type: core_1.Input
        }], setSVGAttributes: [{
            type: core_1.Input
        }], removeSVGAttributes: [{
            type: core_1.Input
        }], fallbackImgUrl: [{
            type: core_1.Input
        }], onSVGLoaded: [{
            type: core_1.Input
        }] }); })();
    return InlineSVGDirective;
}());
exports.InlineSVGDirective = InlineSVGDirective;

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5saW5lLXN2Zy5kaXJlY3RpdmUuanMiLCJzb3VyY2VzIjpbImlubGluZS1zdmcuZGlyZWN0aXZlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUNBS087QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUEyQjtBQUMzQjtBQUNBO0FBQ0EiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xyXG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcclxuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XHJcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xyXG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcclxufTtcclxudmFyIF9fbWV0YWRhdGEgPSAodGhpcyAmJiB0aGlzLl9fbWV0YWRhdGEpIHx8IGZ1bmN0aW9uIChrLCB2KSB7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QubWV0YWRhdGEgPT09IFwiZnVuY3Rpb25cIikgcmV0dXJuIFJlZmxlY3QubWV0YWRhdGEoaywgdik7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG52YXIgY29yZV8xID0gcmVxdWlyZShcIkBhbmd1bGFyL2NvcmVcIik7XHJcbnZhciBjb21tb25fMSA9IHJlcXVpcmUoXCJAYW5ndWxhci9jb21tb25cIik7XHJcbnZhciBpbmxpbmVfc3ZnX2NvbXBvbmVudF8xID0gcmVxdWlyZShcIi4vaW5saW5lLXN2Zy5jb21wb25lbnRcIik7XHJcbnZhciBzdmdfY2FjaGVfc2VydmljZV8xID0gcmVxdWlyZShcIi4vc3ZnLWNhY2hlLnNlcnZpY2VcIik7XHJcbnZhciBpbmxpbmVfc3ZnX3NlcnZpY2VfMSA9IHJlcXVpcmUoXCIuL2lubGluZS1zdmcuc2VydmljZVwiKTtcclxudmFyIGlubGluZV9zdmdfY29uZmlnXzEgPSByZXF1aXJlKFwiLi9pbmxpbmUtc3ZnLmNvbmZpZ1wiKTtcclxudmFyIFN2Z1V0aWwgPSByZXF1aXJlKFwiLi9zdmctdXRpbFwiKTtcclxudmFyIElubGluZVNWR0RpcmVjdGl2ZSA9IChmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBJbmxpbmVTVkdEaXJlY3RpdmUoX2VsLCBfdmlld0NvbnRhaW5lclJlZiwgX3Jlc29sdmVyLCBfc3ZnQ2FjaGUsIF9yZW5kZXJlciwgX2lubGluZVNWR1NlcnZpY2UsIF9jb25maWcsIHBsYXRmb3JtSWQpIHtcclxuICAgICAgICB0aGlzLl9lbCA9IF9lbDtcclxuICAgICAgICB0aGlzLl92aWV3Q29udGFpbmVyUmVmID0gX3ZpZXdDb250YWluZXJSZWY7XHJcbiAgICAgICAgdGhpcy5fcmVzb2x2ZXIgPSBfcmVzb2x2ZXI7XHJcbiAgICAgICAgdGhpcy5fc3ZnQ2FjaGUgPSBfc3ZnQ2FjaGU7XHJcbiAgICAgICAgdGhpcy5fcmVuZGVyZXIgPSBfcmVuZGVyZXI7XHJcbiAgICAgICAgdGhpcy5faW5saW5lU1ZHU2VydmljZSA9IF9pbmxpbmVTVkdTZXJ2aWNlO1xyXG4gICAgICAgIHRoaXMuX2NvbmZpZyA9IF9jb25maWc7XHJcbiAgICAgICAgdGhpcy5wbGF0Zm9ybUlkID0gcGxhdGZvcm1JZDtcclxuICAgICAgICB0aGlzLnJlc29sdmVTVkdVcmwgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMucmVwbGFjZUNvbnRlbnRzID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLnByZXBlbmQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmluamVjdENvbXBvbmVudCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuY2FjaGVTVkcgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMuZm9yY2VFdmFsU3R5bGVzID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5ldmFsU2NyaXB0cyA9IFwiYWx3YXlzXCI7XHJcbiAgICAgICAgdGhpcy5vblNWR0luc2VydGVkID0gbmV3IGNvcmVfMS5FdmVudEVtaXR0ZXIoKTtcclxuICAgICAgICB0aGlzLm9uU1ZHRmFpbGVkID0gbmV3IGNvcmVfMS5FdmVudEVtaXR0ZXIoKTtcclxuICAgICAgICB0aGlzLl9zdXBwb3J0c1NWRyA9IFN2Z1V0aWwuaXNTdmdTdXBwb3J0ZWQoKTtcclxuICAgICAgICBpZiAoIWNvbW1vbl8xLmlzUGxhdGZvcm1TZXJ2ZXIodGhpcy5wbGF0Zm9ybUlkKSAmJiAhdGhpcy5fc3VwcG9ydHNTVkcpIHtcclxuICAgICAgICAgICAgdGhpcy5fZmFpbCgnRW1iZWQgU1ZHIGFyZSBub3Qgc3VwcG9ydGVkIGJ5IHRoaXMgYnJvd3NlcicpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUubmdPbkluaXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLl9pc1ZhbGlkUGxhdGZvcm0oKSB8fCB0aGlzLl9pc1NTUkRpc2FibGVkKCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9pbnNlcnRTVkcoKTtcclxuICAgIH07XHJcbiAgICBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLm5nT25DaGFuZ2VzID0gZnVuY3Rpb24gKGNoYW5nZXMpIHtcclxuICAgICAgICBpZiAoIXRoaXMuX2lzVmFsaWRQbGF0Zm9ybSgpIHx8IHRoaXMuX2lzU1NSRGlzYWJsZWQoKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjaGFuZ2VzWydpbmxpbmVTVkcnXSB8fCBjaGFuZ2VzWydzZXRTVkdBdHRyaWJ1dGVzJ10pIHtcclxuICAgICAgICAgICAgdGhpcy5faW5zZXJ0U1ZHKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUubmdPbkRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3N1YnNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgSW5saW5lU1ZHRGlyZWN0aXZlLnByb3RvdHlwZS5faW5zZXJ0U1ZHID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKCFjb21tb25fMS5pc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkgJiYgIXRoaXMuX3N1cHBvcnRzU1ZHKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLmlubGluZVNWRykge1xyXG4gICAgICAgICAgICB0aGlzLl9mYWlsKCdObyBVUkwgcGFzc2VkIHRvIFtpbmxpbmVTVkddJyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuaW5saW5lU1ZHID09PSB0aGlzLl9wcmV2VXJsKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fcHJldlVybCA9IHRoaXMuaW5saW5lU1ZHO1xyXG4gICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbiA9IHRoaXMuX3N2Z0NhY2hlLmdldFNWRyh0aGlzLmlubGluZVNWRywgdGhpcy5yZXNvbHZlU1ZHVXJsLCB0aGlzLmNhY2hlU1ZHKVxyXG4gICAgICAgICAgICAuc3Vic2NyaWJlKGZ1bmN0aW9uIChzdmcpIHtcclxuICAgICAgICAgICAgaWYgKFN2Z1V0aWwuaXNVcmxTeW1ib2woX3RoaXMuaW5saW5lU1ZHKSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHN5bWJvbElkID0gX3RoaXMuaW5saW5lU1ZHLnNwbGl0KCcjJylbMV07XHJcbiAgICAgICAgICAgICAgICBzdmcgPSBTdmdVdGlsLmNyZWF0ZVN5bWJvbFN2ZyhfdGhpcy5fcmVuZGVyZXIsIHN2Zywgc3ltYm9sSWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIF90aGlzLl9wcm9jZXNzU3ZnKHN2Zyk7XHJcbiAgICAgICAgfSwgZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgICAgICBfdGhpcy5fZmFpbChlcnIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUuX3Byb2Nlc3NTdmcgPSBmdW5jdGlvbiAoc3ZnKSB7XHJcbiAgICAgICAgaWYgKCFzdmcpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5yZW1vdmVTVkdBdHRyaWJ1dGVzICYmIGNvbW1vbl8xLmlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcclxuICAgICAgICAgICAgU3ZnVXRpbC5yZW1vdmVBdHRyaWJ1dGVzKHN2ZywgdGhpcy5yZW1vdmVTVkdBdHRyaWJ1dGVzKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuc2V0U1ZHQXR0cmlidXRlcykge1xyXG4gICAgICAgICAgICBTdmdVdGlsLnNldEF0dHJpYnV0ZXMoc3ZnLCB0aGlzLnNldFNWR0F0dHJpYnV0ZXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5vblNWR0xvYWRlZCkge1xyXG4gICAgICAgICAgICBzdmcgPSB0aGlzLm9uU1ZHTG9hZGVkKHN2ZywgdGhpcy5fZWwubmF0aXZlRWxlbWVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX2luc2VydEVsKHN2Zyk7XHJcbiAgICAgICAgaWYgKGNvbW1vbl8xLmlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcclxuICAgICAgICAgICAgdGhpcy5faW5saW5lU1ZHU2VydmljZS5ldmFsU2NyaXB0cyhzdmcsIHRoaXMuaW5saW5lU1ZHLCB0aGlzLmV2YWxTY3JpcHRzKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuZm9yY2VFdmFsU3R5bGVzKSB7XHJcbiAgICAgICAgICAgIHZhciBzdHlsZVRhZ3MgPSBzdmcucXVlcnlTZWxlY3RvckFsbCgnc3R5bGUnKTtcclxuICAgICAgICAgICAgQXJyYXkuZnJvbShzdHlsZVRhZ3MpLmZvckVhY2goZnVuY3Rpb24gKHRhZykgeyByZXR1cm4gdGFnLnRleHRDb250ZW50ICs9ICcnOyB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5vblNWR0luc2VydGVkLmVtaXQoc3ZnKTtcclxuICAgIH07XHJcbiAgICBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLl9pbnNlcnRFbCA9IGZ1bmN0aW9uIChlbCkge1xyXG4gICAgICAgIGlmICh0aGlzLmluamVjdENvbXBvbmVudCkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuX3N2Z0NvbXApIHtcclxuICAgICAgICAgICAgICAgIHZhciBmYWN0b3J5ID0gdGhpcy5fcmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoaW5saW5lX3N2Z19jb21wb25lbnRfMS5JbmxpbmVTVkdDb21wb25lbnQpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fc3ZnQ29tcCA9IHRoaXMuX3ZpZXdDb250YWluZXJSZWYuY3JlYXRlQ29tcG9uZW50KGZhY3RvcnkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuX3N2Z0NvbXAuaW5zdGFuY2UuY29udGV4dCA9IHRoaXM7XHJcbiAgICAgICAgICAgIHRoaXMuX3N2Z0NvbXAuaW5zdGFuY2UucmVwbGFjZUNvbnRlbnRzID0gdGhpcy5yZXBsYWNlQ29udGVudHM7XHJcbiAgICAgICAgICAgIHRoaXMuX3N2Z0NvbXAuaW5zdGFuY2UucHJlcGVuZCA9IHRoaXMucHJlcGVuZDtcclxuICAgICAgICAgICAgdGhpcy5fc3ZnQ29tcC5pbnN0YW5jZS5jb250ZW50ID0gZWw7XHJcbiAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLmFwcGVuZENoaWxkKHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQsIHRoaXMuX3N2Z0NvbXAuaW5qZWN0b3IuZ2V0KGlubGluZV9zdmdfY29tcG9uZW50XzEuSW5saW5lU1ZHQ29tcG9uZW50KS5fZWwubmF0aXZlRWxlbWVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLl9pbmxpbmVTVkdTZXJ2aWNlLmluc2VydEVsKHRoaXMsIHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQsIGVsLCB0aGlzLnJlcGxhY2VDb250ZW50cywgdGhpcy5wcmVwZW5kKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgSW5saW5lU1ZHRGlyZWN0aXZlLnByb3RvdHlwZS5fZmFpbCA9IGZ1bmN0aW9uIChtc2cpIHtcclxuICAgICAgICB0aGlzLm9uU1ZHRmFpbGVkLmVtaXQobXNnKTtcclxuICAgICAgICBpZiAodGhpcy5mYWxsYmFja0ltZ1VybCkge1xyXG4gICAgICAgICAgICB2YXIgZWxJbWcgPSB0aGlzLl9yZW5kZXJlci5jcmVhdGVFbGVtZW50KCdJTUcnKTtcclxuICAgICAgICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0QXR0cmlidXRlKGVsSW1nLCAnc3JjJywgdGhpcy5mYWxsYmFja0ltZ1VybCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2luc2VydEVsKGVsSW1nKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgSW5saW5lU1ZHRGlyZWN0aXZlLnByb3RvdHlwZS5faXNWYWxpZFBsYXRmb3JtID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBjb21tb25fMS5pc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkgfHwgY29tbW9uXzEuaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKTtcclxuICAgIH07XHJcbiAgICBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLl9pc1NTUkRpc2FibGVkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBjb21tb25fMS5pc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkgJiYgdGhpcy5fY29uZmlnICYmIHRoaXMuX2NvbmZpZy5jbGllbnRPbmx5O1xyXG4gICAgfTtcclxuICAgIF9fZGVjb3JhdGUoW1xyXG4gICAgICAgIGNvcmVfMS5JbnB1dCgpLFxyXG4gICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246dHlwZVwiLCBTdHJpbmcpXHJcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcImlubGluZVNWR1wiLCB2b2lkIDApO1xyXG4gICAgX19kZWNvcmF0ZShbXHJcbiAgICAgICAgY29yZV8xLklucHV0KCksXHJcbiAgICAgICAgX19tZXRhZGF0YShcImRlc2lnbjp0eXBlXCIsIEJvb2xlYW4pXHJcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcInJlc29sdmVTVkdVcmxcIiwgdm9pZCAwKTtcclxuICAgIF9fZGVjb3JhdGUoW1xyXG4gICAgICAgIGNvcmVfMS5JbnB1dCgpLFxyXG4gICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246dHlwZVwiLCBCb29sZWFuKVxyXG4gICAgXSwgSW5saW5lU1ZHRGlyZWN0aXZlLnByb3RvdHlwZSwgXCJyZXBsYWNlQ29udGVudHNcIiwgdm9pZCAwKTtcclxuICAgIF9fZGVjb3JhdGUoW1xyXG4gICAgICAgIGNvcmVfMS5JbnB1dCgpLFxyXG4gICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246dHlwZVwiLCBCb29sZWFuKVxyXG4gICAgXSwgSW5saW5lU1ZHRGlyZWN0aXZlLnByb3RvdHlwZSwgXCJwcmVwZW5kXCIsIHZvaWQgMCk7XHJcbiAgICBfX2RlY29yYXRlKFtcclxuICAgICAgICBjb3JlXzEuSW5wdXQoKSxcclxuICAgICAgICBfX21ldGFkYXRhKFwiZGVzaWduOnR5cGVcIiwgQm9vbGVhbilcclxuICAgIF0sIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUsIFwiaW5qZWN0Q29tcG9uZW50XCIsIHZvaWQgMCk7XHJcbiAgICBfX2RlY29yYXRlKFtcclxuICAgICAgICBjb3JlXzEuSW5wdXQoKSxcclxuICAgICAgICBfX21ldGFkYXRhKFwiZGVzaWduOnR5cGVcIiwgQm9vbGVhbilcclxuICAgIF0sIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUsIFwiY2FjaGVTVkdcIiwgdm9pZCAwKTtcclxuICAgIF9fZGVjb3JhdGUoW1xyXG4gICAgICAgIGNvcmVfMS5JbnB1dCgpLFxyXG4gICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246dHlwZVwiLCBPYmplY3QpXHJcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcInNldFNWR0F0dHJpYnV0ZXNcIiwgdm9pZCAwKTtcclxuICAgIF9fZGVjb3JhdGUoW1xyXG4gICAgICAgIGNvcmVfMS5JbnB1dCgpLFxyXG4gICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246dHlwZVwiLCBBcnJheSlcclxuICAgIF0sIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUsIFwicmVtb3ZlU1ZHQXR0cmlidXRlc1wiLCB2b2lkIDApO1xyXG4gICAgX19kZWNvcmF0ZShbXHJcbiAgICAgICAgY29yZV8xLklucHV0KCksXHJcbiAgICAgICAgX19tZXRhZGF0YShcImRlc2lnbjp0eXBlXCIsIEJvb2xlYW4pXHJcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcImZvcmNlRXZhbFN0eWxlc1wiLCB2b2lkIDApO1xyXG4gICAgX19kZWNvcmF0ZShbXHJcbiAgICAgICAgY29yZV8xLklucHV0KCksXHJcbiAgICAgICAgX19tZXRhZGF0YShcImRlc2lnbjp0eXBlXCIsIFN0cmluZylcclxuICAgIF0sIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUsIFwiZXZhbFNjcmlwdHNcIiwgdm9pZCAwKTtcclxuICAgIF9fZGVjb3JhdGUoW1xyXG4gICAgICAgIGNvcmVfMS5JbnB1dCgpLFxyXG4gICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246dHlwZVwiLCBTdHJpbmcpXHJcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcImZhbGxiYWNrSW1nVXJsXCIsIHZvaWQgMCk7XHJcbiAgICBfX2RlY29yYXRlKFtcclxuICAgICAgICBjb3JlXzEuSW5wdXQoKSxcclxuICAgICAgICBfX21ldGFkYXRhKFwiZGVzaWduOnR5cGVcIiwgRnVuY3Rpb24pXHJcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcIm9uU1ZHTG9hZGVkXCIsIHZvaWQgMCk7XHJcbiAgICBfX2RlY29yYXRlKFtcclxuICAgICAgICBjb3JlXzEuT3V0cHV0KCksXHJcbiAgICAgICAgX19tZXRhZGF0YShcImRlc2lnbjp0eXBlXCIsIGNvcmVfMS5FdmVudEVtaXR0ZXIpXHJcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUucHJvdG90eXBlLCBcIm9uU1ZHSW5zZXJ0ZWRcIiwgdm9pZCAwKTtcclxuICAgIF9fZGVjb3JhdGUoW1xyXG4gICAgICAgIGNvcmVfMS5PdXRwdXQoKSxcclxuICAgICAgICBfX21ldGFkYXRhKFwiZGVzaWduOnR5cGVcIiwgY29yZV8xLkV2ZW50RW1pdHRlcilcclxuICAgIF0sIElubGluZVNWR0RpcmVjdGl2ZS5wcm90b3R5cGUsIFwib25TVkdGYWlsZWRcIiwgdm9pZCAwKTtcclxuICAgIElubGluZVNWR0RpcmVjdGl2ZSA9IF9fZGVjb3JhdGUoW1xyXG4gICAgICAgIGNvcmVfMS5EaXJlY3RpdmUoe1xyXG4gICAgICAgICAgICBzZWxlY3RvcjogJ1tpbmxpbmVTVkddJyxcclxuICAgICAgICAgICAgcHJvdmlkZXJzOiBbc3ZnX2NhY2hlX3NlcnZpY2VfMS5TVkdDYWNoZVNlcnZpY2VdXHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgX19wYXJhbSg2LCBjb3JlXzEuT3B0aW9uYWwoKSksXHJcbiAgICAgICAgX19wYXJhbSg3LCBjb3JlXzEuSW5qZWN0KGNvcmVfMS5QTEFURk9STV9JRCkpLFxyXG4gICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246cGFyYW10eXBlc1wiLCBbY29yZV8xLkVsZW1lbnRSZWYsXHJcbiAgICAgICAgICAgIGNvcmVfMS5WaWV3Q29udGFpbmVyUmVmLFxyXG4gICAgICAgICAgICBjb3JlXzEuQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgICAgICAgICBzdmdfY2FjaGVfc2VydmljZV8xLlNWR0NhY2hlU2VydmljZSxcclxuICAgICAgICAgICAgY29yZV8xLlJlbmRlcmVyMixcclxuICAgICAgICAgICAgaW5saW5lX3N2Z19zZXJ2aWNlXzEuSW5saW5lU1ZHU2VydmljZSxcclxuICAgICAgICAgICAgaW5saW5lX3N2Z19jb25maWdfMS5JbmxpbmVTVkdDb25maWcsXHJcbiAgICAgICAgICAgIE9iamVjdF0pXHJcbiAgICBdLCBJbmxpbmVTVkdEaXJlY3RpdmUpO1xyXG4gICAgcmV0dXJuIElubGluZVNWR0RpcmVjdGl2ZTtcclxufSgpKTtcclxuZXhwb3J0cy5JbmxpbmVTVkdEaXJlY3RpdmUgPSBJbmxpbmVTVkdEaXJlY3RpdmU7XHJcbiJdfQ==